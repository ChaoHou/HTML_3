<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>Netball Info(2008-2013)</title>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
    <style>
        text {
            pointer-events: none;
            cursor: pointer;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .axis {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        #pool:hover {
            fill: GoldenRod;
        }
    </style>
</head>
<body>
    <script>

        var height = 800, width = 1200, poolHeight = 60,
            nodeHeight = 30, textHeight = 14, charWidth = 8,
            offsetTop = 100, offsetLeft = offsetRight = 100,
            widthLimit = width - offsetLeft - offsetRight,
            nodeGap = 10, groupGap = 50,
            titleOffset = 10, titleHeight = 24;

        var teams =  [{"text":"Adelaide Thunderbirds"},
                      {"text":"Canterbury Tactix"},
                      {"text":"Central Pulse"},
                      {"text":"Melbourne Vixens"},
                      {"text":"New South Wales Swifts"},
                      {"text":"Northern Mystics"},
                      {"text":"Queensland Firebirds"},
                      {"text":"Southern Steel"},
                      {"text":"Waikato Bay of Plenty Magic"},
                      {"text":"West Coast Fever"}];
        initArray(teams,"yellow","team",0);

        var countries = [{"text":"New Zealand"},
                        {"text":"Australia"}];
        initArray(countries,"aquamarine","country",1);

        var venues = [{"text":"Adelaide Arena, Adelaide"},
                      {"text":"Arena Manawatu, Palmerston North"},
                      {"text":"Brisbane Convention and Exhibition Centre"},
                      {"text":"Challenge Stadium, Perth"},
                      {"text":"ETSA Park, Adelaide"},
                      {"text":"Energy Events Centre, Rotorua"},
                      {"text":"Hisense Arena, Melbourne"},
                      {"text":"Mystery Creek Events Centre, Hamilton"},
                      {"text":"North Shore Events Centre, Auckland"},
                      {"text":"Queen Elizabeth Youth Centre, Tauranga"},
                      {"text":"Stadium Southland, Invercargill"},
                      {"text":"State Netball and Hockey Centre, Melbourne"},
                      {"text":"Sydney Olympic Park Sports Centre"},
                      {"text":"TSB Bank Arena, Wellington"},
                      {"text":"Te Rauparaha Arena, Porirua"},
                      {"text":"The Edgar Centre, Dunedin"},
                      {"text":"Trusts Stadium, Auckland"},
                      {"text":"Westpac Arena, Christchurch"}];
        initArray(venues,"orange","venue",2);

	    var years = [{"text":2008},
				    {"text":2009},
				    {"text":2010},
				    {"text":2011},
				    {"text":2012},
				    {"text":2013}]
	    initArray(years,"bisque","year",3);

        var data = teams.concat(countries,venues,years);
        calculateFixedPos(data);

        var titleData = generateTitles(data);
    
        var svg = d3.select("body")
                    .append("svg")
                    .attr("height",height)
                    .attr("width",width)
				    .style("position","absolute");


        var force = d3.layout.force()
                              .nodes(data)
                              .size([width,height])
                              .charge(0)
                              .gravity(0);
	    force.start();

	    var nodes = svg.selectAll("g")
                    .data(data)
                    .enter()
                    .append("g")
	    .call(force.drag);

	    nodes.append("rect")
            .attr("width", function (d) { return d.width + nodeHeight/2; })
            .attr("height", nodeHeight)
            .style("fill", function (d) { return d.color })
		
        nodes.append("text")
            .style("font-size", textHeight)
		    .style("font-family", "Impact")
            .attr("textLength", function (d) { return d.width; })
		    .attr("dy", function (d, i) { return textHeight/2; })
            .attr("x", nodeHeight/4)
	        .attr("y", nodeHeight/2)
            .attr("fill", "black")
		    .text(function (d) { return d.text; })

        var title = svg.selectAll(".title")
                        .data(titleData)
                        .enter()
                        .append("text")
                        .attr("class", ".title")
                        .style("font-size", titleHeight)
		                .style("font-family", "Impact")
                        .text(function (d) { return d.text });

        force.on("tick", function (e) {
            calculateFixedPos(data);
            title.each(graviry(e.alpha*0.2)).attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
            nodes.each(graviry(e.alpha*0.2))
                .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
        })

        function graviry(alpha) {
            return function (d) {
                d.y += (d.fixedY - d.y) * alpha;
                d.x += (d.fixedX - d.x) * alpha;
            }
        }

        function initArray(data,color,type,group){
            for(var i=0;i<data.length;i++){
                data[i].color = color;
                data[i].type = type;
                data[i].index = i;
                data[i].width = textLength(data[i].text);
                data[i].group = group;
            }
            return data;
        }

        function generateTitles(data) {
            data.sort(function (a, b) { return a.group * 100 + a.index - b.group * 100 - b.index });
            var array = [];
            
            for (var i = 0; i < data.length; i++) {
                var title = {};
                title.type = data[i].type;
                title.text = capitalize(data[i].type);
                title.fixedX = title.x = offsetLeft + titleOffset;
                title.fixedY = title.y = data[i].fixedY - titleOffset;
                if (array.length == 0) {
                    array.push(title);
                } else {
                    if (array[array.length - 1].type != title.type) {
                        array.push(title);
                    }
                }
            }
            return array;
        }

        function textLength(text){
            return text.toString().length * charWidth;
        }

        function capitalize(text) {
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        function calculateFixedPos(array) {
            array.sort(function (a, b) { return a.group * 100 + a.index - b.group * 100 - b.index });

            var x = offsetLeft, y = offsetTop + groupGap;
            for (var i = 0; i < array.length; i++) {
                array[i].fixedX = x;
                array[i].fixedY = y;

                if (i + 1 < array.length) {
                    if (array[i].group != array[i + 1].group) {
                        x = offsetLeft;
                        y = y + groupGap + nodeHeight;
                        continue;
                    }

                    var newWidth = x + array[i].width + nodeHeight / 2 + nodeGap
                                    + array[i + 1].width + nodeHeight / 2 - offsetLeft;
                    if (newWidth <= widthLimit) {
                        x = x + array[i].width + nodeHeight / 2 + nodeGap;
                    } else {
                        x = offsetLeft;
                        y = y + nodeGap + nodeHeight;
                    }
                    
                }
                
            }
        }



    </script>
</body>
</html>
